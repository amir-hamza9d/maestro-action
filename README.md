# Maestro Mobile App Testing with Visual Regression

Automated testing suite for mobile applications using Maestro, a mobile UI testing framework, with integrated visual regression testing capabilities.

## Overview

This project provides a complete setup for mobile app testing with Maestro, including:

- Functional testing of mobile app features
- Visual regression testing with screenshot comparison
- GitHub Actions integration for CI/CD
- Applitools integration for AI-powered visual testing

The example tests are configured for a PDF Reader Android application (package: `pdfreader.pdfviewer.officetool.pdfscanner`), but can be adapted for any mobile app.

## Project Structure

- `flows/` - Contains Maestro test flows in YAML format
  - `baseCheck.yaml` - Basic app functionality verification
  - `permission.yaml` - Tests permission handling
  - `verify_demo_pdf.yaml` - Verifies demo PDF functionality
  - `smoke.yaml` - Combines multiple tests for smoke testing
- `hooks/` - Contains reusable test components
  - `beforeHook.yaml` - Setup operations run before tests
  - `afterHook.yaml` - Operations run after tests, including visual regression testing
- `scripts/` - Contains shell scripts for test execution
  - `run_maestro_simple.sh` - Basic test runner
  - `run_maestro_advanced.sh` - Advanced test runner with retries
  - `run_maestro_tests.sh` - Main test execution script
  - `run_failed_tests.sh` - Script to re-run failed tests
  - `compare_screenshots.js` - Visual regression testing script
  - `applitools_compare.js` - Applitools integration for visual testing
- `Screen-shots/` - Directory structure for visual regression testing
  - `Expected/` - Baseline screenshots for comparison
  - `Actual/` - Screenshots captured during test runs
  - `Diff/` - Difference images generated by comparison
- `artifacts/` - Directory for test reports and failure artifacts
- `app-elements/` - Contains JavaScript helper files for test flows
- `.github/workflows/` - GitHub Actions workflow configurations

## Prerequisites

### For Maestro Testing
- Maestro CLI installed (`~/.maestro/bin/maestro`)
- Android SDK installed with environment variables set
- Connected Android device or emulator

### For Visual Regression Testing
- Node.js and npm installed
- Required npm packages:
  ```bash
  npm install
  ```
- Manually created screenshot directories:
  ```bash
  mkdir -p Screen-shots/Expected Screen-shots/Actual Screen-shots/Diff
  ```

### For Applitools Integration (Optional)
- Applitools account (sign up at [https://applitools.com/](https://applitools.com/))
- Applitools API key
- Additional npm packages:
  ```bash
  npm install @applitools/eyes-images dotenv --save
  ```

## Running Tests

### Functional Testing with Maestro

#### Basic Test Run

```bash
./scripts/run_maestro_simple.sh
```

This will run all tests in the `flows/` directory and generate an HTML report in the `artifacts/` directory.

#### Advanced Test Run with Retries

```bash
./scripts/run_maestro_advanced.sh [--app-id APP_ID] [--test-dir DIR] [--flow FLOW_FILE] [--retries NUM]
```

Options:
- `--app-id` - Specify the application ID (default: pdfreader.pdfviewer.officetool.pdfscanner)
- `--test-dir` - Specify the test directory (default: flows)
- `--flow` - Run a specific flow file
- `--retries` - Number of retry attempts (default: 3)

#### Re-running Failed Tests

```bash
./scripts/run_failed_tests.sh
```

This will re-run only the tests that failed in the previous run, as listed in `failed_tests.txt`.

### Visual Regression Testing

#### Capturing Baseline Screenshots

1. Run your Maestro tests to capture screenshots in the `Screen-shots/Actual` directory
2. Review the screenshots and copy the ones you want to use as baselines to the `Screen-shots/Expected` directory:

```bash
# Example: Copy all screenshots from Actual to Expected to establish initial baselines
cp Screen-shots/Actual/*.png Screen-shots/Expected/
```

#### Running Visual Regression Tests

When you run Maestro tests with the `afterHook.yaml` configured, visual regression testing will run automatically after test execution. The script compares screenshots in the `Screen-shots/Actual` directory with baselines in the `Screen-shots/Expected` directory.

You can also manually run the comparison script:

```bash
npm run compare-screenshots
```

#### Reviewing Results

After running the tests:

1. Check the console output for a summary of the comparison results
2. Review any difference images in the `Screen-shots/Diff` directory:
   - Differences are highlighted in pink
   - A bold, bright yellow border surrounds the differences for enhanced visibility
   - The rest of the image remains fully visible at normal opacity

### Applitools Visual Testing (Optional)

#### Setting Up Applitools

1. Set your Applitools API key using one of these methods:

   **Option 1: Using a .env file (recommended)**
   ```bash
   # Create a .env file with your API key
   echo "APPLITOOLS_API_KEY=your_api_key_here" > .env
   ```

   **Option 2: Set as an environment variable**
   ```bash
   export APPLITOOLS_API_KEY=your_api_key_here
   ```

2. Run the Applitools comparison script:

```bash
npm run applitools-compare
```

You can configure the Applitools integration using environment variables:

| Environment Variable | Description | Default Value |
|---------------------|-------------|---------------|
| `APPLITOOLS_API_KEY` | Your Applitools API key (required) | None |
| `APPLITOOLS_APP_NAME` | Name of your application | "Maestro App" |
| `APPLITOOLS_BATCH_NAME` | Name of the test batch | "Visual Tests - [current date]" |
| `APPLITOOLS_MATCH_LEVEL` | Match level for comparison (Exact, Strict, Content, Layout) | "Strict" |

## Test Reports

Test reports are generated in HTML format in the `artifacts/` directory. For failed tests, the following artifacts are collected:
- Screenshots
- Screen recordings
- Detailed error logs

## Test Configuration

The `.maestro/config.yaml` file contains global configuration for test execution, including:
- Flow inclusion/exclusion patterns
- Tag-based filtering
- Execution order settings

## Writing Tests

Tests are written in YAML format following the Maestro syntax. Example:

```yaml
appId: pdfreader.pdfviewer.officetool.pdfscanner
---
- assertVisible:
    text: "Open"
    label: "Verify the Open button is visible"
- tapOn:
    text: "Open"
    label: "Tap on open for file manager"
```

## GitHub Actions Integration

This project includes GitHub Actions workflows for automated testing in CI/CD pipelines:

### Android E2E Testing Workflow

The workflow in `.github/workflows/maestro-tests.yml` runs Maestro tests on a Genymotion Cloud Android emulator when a pull request is created against the main branch.

Key features:
- Uses Genymotion Cloud for Android emulation
- Installs and configures Maestro
- Runs all test flows
- Automatically retries failed tests
- Uploads test reports and artifacts

To use this workflow in your own project:
1. Configure the Genymotion Cloud credentials
2. Adjust the Android device ID if needed
3. Update the app installation path

### Adding Applitools to CI/CD

To integrate Applitools visual testing in your CI/CD pipeline:

1. Add your Applitools API key as a GitHub secret named `APPLITOOLS_API_KEY`
2. Add a step to your workflow:

```yaml
- name: Run Applitools visual tests
  run: npm run applitools-compare
  env:
    APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
    APPLITOOLS_APP_NAME: "Your App Name"
```

## Troubleshooting

### Visual Regression Testing

- **Missing directories**: Ensure you've manually created the Screen-shots/Expected, Screen-shots/Actual, and Screen-shots/Diff directories before running tests.
- **Missing screenshots**: Ensure your Maestro tests include `takeScreenshot` commands.
- **Dimension mismatch errors**: Make sure the baseline and actual screenshots have the same dimensions.
- **False positives**: Adjust the threshold in the comparison script if needed.

### Applitools Integration

- **API Key Issues**: Make sure your Applitools API key is correctly set.
- **Connection Issues**: Check your internet connection and firewall settings.

## Dependencies

This project uses the following dependencies:
- [Maestro](https://maestro.mobile.dev/) - Mobile UI testing framework
- [pixelmatch](https://github.com/mapbox/pixelmatch) - Pixel-level image comparison
- [pngjs](https://github.com/lukeapage/pngjs) - PNG image processing
- [fs-extra](https://github.com/jprichardson/node-fs-extra) - Enhanced file system operations
- [Applitools Eyes](https://applitools.com/) - AI-powered visual testing (optional)
- Android Emulator
- Java
- Node.js

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.


Automate with Love ❤️
